"use strict";(()=>{var e={};e.id=572,e.ids=[572],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},8294:(e,r,o)=>{o.r(r),o.d(r,{originalPathname:()=>x,patchFetch:()=>h,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var t={};o.r(t),o.d(t,{GET:()=>u,POST:()=>d,dynamic:()=>c});var s=o(9303),n=o(8716),a=o(670),i=o(344),l=o(1615),p=o(7070);let c="force-dynamic";async function u(e){console.log("[API] Initializing Supabase client...");try{let r=(0,i.createRouteHandlerClient)({cookies:l.cookies});console.log("[API] Supabase client initialized.");let{searchParams:o}=new URL(e.url),t=o.get("search"),{data:{session:s},error:n}=await r.auth.getSession();if(n)return console.error("[API] Auth Session Error:",n.message),p.NextResponse.json({error:`Authentication error: ${n.message}`},{status:401});if(!s)return console.warn("[API] No active session found."),p.NextResponse.json({error:"Unauthorized: Please log in"},{status:401});console.log(`[API] Fetching profile for user: ${s.user.id}`);let{data:a,error:c}=await r.from("profiles").select("company_id").eq("id",s.user.id).single();if(c){if(console.error("[API] Profile Fetch Error:",c.message),"42P01"===c.code)return console.warn("[API] Fallback: Profiles table does not exist. Check migrations."),p.NextResponse.json({error:'Database table "profiles" missing. Did you run the Supabase migrations?',fallback:!0},{status:500});return p.NextResponse.json({error:`Authorization error: ${c.message}`},{status:403})}if(!a?.company_id)return console.warn(`[API] No company_id found for user ${s.user.id}`),p.NextResponse.json({error:"User is not associated with any company profile."},{status:403});console.log(`[API] Executing query for company: ${a.company_id}`);let u=r.from("employees").select("*, visas(*)").eq("company_id",a.company_id);t&&(console.log(`[API] Applying search filter: "${t}"`),u=u.or(`first_name.ilike.%${t}%,last_name.ilike.%${t}%,passport_number.ilike.%${t}%`));let{data:d,error:m}=await u;if(m){if(console.error("[API] Employee Fetch Error:",m.message),console.error("[API] Error Code:",m.code),"42P01"===m.code)return console.warn("[API] Fallback: Employees table does not exist. Returning empty array with warning."),p.NextResponse.json([],{headers:{"X-Warning":'Database table "employees" missing. Migrations required.'}});return p.NextResponse.json({error:`Database error: ${m.message}`},{status:500})}return console.log(`[API] Successfully retrieved ${d?.length||0} employees.`),p.NextResponse.json(d)}catch(e){return console.error("[API] Unexpected Server Error:",e),p.NextResponse.json({error:"An unexpected internal server error occurred.",details:e?.message||"No additional details available"},{status:500})}}async function d(e){try{let r=(0,i.createRouteHandlerClient)({cookies:l.cookies}),o=await e.json(),{data:{session:t}}=await r.auth.getSession();if(!t)return p.NextResponse.json({error:"Unauthorized"},{status:401});let{data:s,error:n}=await r.from("profiles").select("company_id").eq("id",t.user.id).single();if(n||!s?.company_id)return p.NextResponse.json({error:"Company profile not found"},{status:403});let{data:a,error:c}=await r.from("employees").insert({company_id:s.company_id,first_name:o.first_name,last_name:o.last_name,email:o.email,phone:o.phone,passport_number:o.passport_number,nationality:o.nationality,position:o.position,department:o.department,status:"active",employment_start_date:o.employment_start_date||null,passport_expiry:o.passport_expiry||null}).select().single();if(c)return console.error("Error creating employee:",c),p.NextResponse.json({error:`Failed to create employee: ${c.message}`},{status:500});return p.NextResponse.json(a)}catch(e){return console.error("Server error:",e),p.NextResponse.json({error:"Internal Server Error"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/employees/route",pathname:"/api/employees",filename:"route",bundlePath:"app/api/employees/route"},resolvedPagePath:"/Users/glennbundy/Desktop/visatrack-malta/app/api/employees/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:f}=m,x="/api/employees/route";function h(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}}};var r=require("../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[276,564,958],()=>o(8294));module.exports=t})();